<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilha de Frequência de Alas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        .table-container::-webkit-scrollbar {
            height: 8px;
        }
        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app-container" class="container mx-auto p-4 md:p-8">
        <!-- O conteúdo será renderizado aqui pelo JavaScript -->
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- CONFIGURAÇÃO ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-alas-app';

        // Lista de Alas
        const alas = [
            "Ala Aracati (SP)", "Ala Chácara Santana", "Ala Interlagos", "Ala Jardim das Acácias",
            "Ala Jardim Ubirajara", "Ala Jurubatuba", "Ala Sabará", "Ala Veleiros",
            "Ala Vila São José", "Ala Grajaú"
        ];
        const NUM_PARTICIPANTS = 20;
        const NUM_WEEKS = 12;

        // --- INICIALIZAÇÃO DO FIREBASE ---
        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Erro ao inicializar o Firebase. Verifique a configuração.", e);
            document.getElementById('app-container').innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                <strong class="font-bold">Erro de Configuração!</strong>
                <span class="block sm:inline">Não foi possível conectar ao Firebase. Verifique as variáveis de ambiente.</span>
            </div>`;
        }
        
        // --- FUNÇÕES AUXILIARES ---
        const slugify = (text) => text.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]+/g, '');

        // --- LÓGICA PRINCIPAL ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Usuário está logado anonimamente
                console.log("Usuário autenticado:", user.uid);
                main();
            } else {
                // Tenta fazer o login anônimo
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                         await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                         await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Erro na autenticação anônima:", error);
                }
            }
        });

        function main() {
            const params = new URLSearchParams(window.location.search);
            const alaParam = params.get('ala');
            const modeParam = params.get('mode');

            if (modeParam === 'admin') {
                renderAdminView();
            } else if (alaParam) {
                const alaName = alas.find(a => slugify(a) === alaParam);
                if (alaName) {
                    renderAlaView(alaName);
                } else {
                    renderNotFound();
                }
            } else {
                renderWelcomePage();
            }
        }

        // --- RENDERIZAÇÃO DAS VIEWS ---

        function renderWelcomePage() {
            const container = document.getElementById('app-container');
            let linksHtml = alas.map(ala => {
                const alaSlug = slugify(ala);
                return `<li><a href="?ala=${alaSlug}" class="text-blue-600 hover:text-blue-800 hover:underline">${ala}</a></li>`;
            }).join('');

            container.innerHTML = `
                <div class="bg-white p-8 rounded-lg shadow-md text-center">
                    <h1 class="text-3xl font-bold text-gray-800 mb-4">Planilha de Frequência</h1>
                    <p class="text-gray-600 mb-8">Selecione uma ala para ver a planilha ou acesse o modo de administração.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-left">
                        <div>
                            <h2 class="text-xl font-semibold mb-4 border-b pb-2">Acesso por Ala</h2>
                            <ul class="space-y-2">
                                ${linksHtml}
                            </ul>
                        </div>
                        <div>
                            <h2 class="text-xl font-semibold mb-4 border-b pb-2">Administração</h2>
                             <a href="?mode=admin" class="text-blue-600 hover:text-blue-800 hover:underline">Ver painel de Admin</a>
                        </div>
                    </div>
                </div>
            `;
        }

        async function renderAlaView(alaName) {
            const container = document.getElementById('app-container');
            const alaId = slugify(alaName);
            
            // Estrutura principal
            container.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-md">
                     <button onclick="window.location.href='${window.location.pathname}'" class="mb-4 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        &larr; Voltar
                    </button>
                    <h1 class="text-3xl font-bold mb-2">${alaName}</h1>
                    <div id="course-info" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-100 rounded-lg"></div>
                    <div id="table-container" class="table-container overflow-x-auto"></div>
                    <div id="loading" class="text-center p-8">Carregando dados...</div>
                </div>
            `;

            renderCourseInfo(alaId);
            renderFrequencyTable(alaName);

            // Carregar dados
            const data = await loadAlaData(alaId);
            document.getElementById('loading').style.display = 'none';

            // Preencher dados do curso
            const courseInfo = data.courseInfo || {};
            document.getElementById('courseName').value = courseInfo.name || '';
            document.getElementById('startDate').value = courseInfo.startDate || '';
            document.getElementById('endDate').value = courseInfo.endDate || '';

            // Preencher dados dos participantes
            for (let i = 0; i < NUM_PARTICIPANTS; i++) {
                const participantData = data.participants[i] || { name: '', attendance: Array(NUM_WEEKS).fill(false) };
                const nameInput = document.getElementById(`participant-name-${i}`);
                if(nameInput) nameInput.value = participantData.name || '';
                
                const attendance = participantData.attendance || Array(NUM_WEEKS).fill(false);
                attendance.forEach((attended, weekIndex) => {
                    const checkbox = document.getElementById(`week-${i}-${weekIndex}`);
                    if(checkbox) checkbox.checked = attended;
                });
                updatePercentage(i);
            }
        }
        
        function renderCourseInfo(alaId) {
            const courseContainer = document.getElementById('course-info');
            courseContainer.innerHTML = `
                <div>
                    <label for="courseName" class="block text-sm font-medium text-gray-700">Nome do Curso</label>
                    <input type="text" id="courseName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="Ex: Doutrina e Convênios">
                </div>
                <div>
                    <label for="startDate" class="block text-sm font-medium text-gray-700">Data de Início</label>
                    <input type="date" id="startDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                </div>
                <div>
                    <label for="endDate" class="block text-sm font-medium text-gray-700">Data de Fim</label>
                    <input type="date" id="endDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                </div>
            `;
            
            // Adicionar event listeners para salvar ao perder o foco
            document.getElementById('courseName').addEventListener('blur', (e) => saveCourseInfo(alaId));
            document.getElementById('startDate').addEventListener('change', (e) => saveCourseInfo(alaId));
            document.getElementById('endDate').addEventListener('change', (e) => saveCourseInfo(alaId));
        }

        function renderFrequencyTable(alaName) {
            const tableContainer = document.getElementById('table-container');
            let tableHeader = '<tr><th class="sticky left-0 bg-gray-100 px-4 py-2 text-left text-sm font-semibold text-gray-900 z-10">Participante</th>';
            for (let i = 1; i <= NUM_WEEKS; i++) {
                tableHeader += `<th class="px-6 py-3 text-center text-sm font-semibold text-gray-900">S${i}</th>`;
            }
            tableHeader += '<th class="px-4 py-2 text-center text-sm font-semibold text-gray-900">Freq. %</th></tr>';

            let tableBody = '';
            for (let i = 0; i < NUM_PARTICIPANTS; i++) {
                tableBody += `<tr>
                    <td class="sticky left-0 bg-white px-2 py-1 z-10">
                        <input type="text" id="participant-name-${i}" placeholder="Participante ${i + 1}" 
                               class="w-48 p-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    </td>`;
                for (let j = 0; j < NUM_WEEKS; j++) {
                    tableBody += `<td class="text-center px-6 py-4">
                                    <input type="checkbox" id="week-${i}-${j}" 
                                           class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                 </td>`;
                }
                tableBody += `<td id="percentage-${i}" class="text-center font-medium">0.00%</td></tr>`;
            }

            tableContainer.innerHTML = `<table class="min-w-full divide-y divide-gray-300">${tableHeader}${tableBody}</table>`;
            
            // Adicionar Event Listeners
            const alaId = slugify(alaName);
            for (let i = 0; i < NUM_PARTICIPANTS; i++) {
                document.getElementById(`participant-name-${i}`).addEventListener('blur', (e) => saveParticipantName(alaId, i, e.target.value));
                for (let j = 0; j < NUM_WEEKS; j++) {
                    document.getElementById(`week-${i}-${j}`).addEventListener('change', (e) => {
                        saveAttendance(alaId, i, j, e.target.checked);
                        updatePercentage(i);
                    });
                }
            }
        }
        
        async function renderAdminView() {
            const container = document.getElementById('app-container');
            container.innerHTML = `
                 <div class="bg-white p-6 rounded-lg shadow-md">
                    <button onclick="window.location.href='${window.location.pathname}'" class="mb-4 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        &larr; Voltar
                    </button>
                    <h1 class="text-3xl font-bold mb-6">Painel de Administração</h1>
                    <div id="admin-content" class="space-y-6">
                        <p>Carregando dados das alas...</p>
                    </div>
                </div>
            `;

            const adminContent = document.getElementById('admin-content');
            adminContent.innerHTML = ''; // Limpa a mensagem de carregamento

            for (const alaName of alas) {
                const alaId = slugify(alaName);
                const data = await loadAlaData(alaId);

                const courseInfo = data.courseInfo || {};
                const participants = data.participants || {};

                let participantsHtml = '';
                for (let i=0; i < NUM_PARTICIPANTS; i++) {
                    const pData = participants[i] || { name: '', attendance: [] };
                    if (pData.name) { // Só mostra participantes com nome
                        const attendedCount = (pData.attendance || []).filter(Boolean).length;
                        const percentage = (attendedCount / NUM_WEEKS * 100).toFixed(2);
                        participantsHtml += `<li class="flex justify-between">
                            <span>${pData.name}</span>
                            <span class="font-mono">${percentage}%</span>
                        </li>`;
                    }
                }
                
                if(!participantsHtml) {
                    participantsHtml = '<li class="text-gray-500">Nenhum participante nomeado.</li>'
                }

                const alaHtml = `
                    <div class="p-4 border rounded-lg bg-gray-50">
                        <h2 class="text-xl font-semibold">${alaName}</h2>
                        <div class="mt-2 text-sm text-gray-600">
                            <p><strong>Curso:</strong> ${courseInfo.name || 'Não definido'}</p>
                            <p><strong>Início:</strong> ${courseInfo.startDate || 'N/D'} | <strong>Fim:</strong> ${courseInfo.endDate || 'N/D'}</p>
                        </div>
                        <h3 class="font-semibold mt-4 mb-2">Frequência dos Participantes:</h3>
                        <ul class="space-y-1 text-sm list-disc list-inside">
                           ${participantsHtml}
                        </ul>
                    </div>
                `;
                adminContent.innerHTML += alaHtml;
            }
        }

        function renderNotFound() {
             document.getElementById('app-container').innerHTML = `
                <div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded relative text-center" role="alert">
                    <strong class="font-bold">Ala não encontrada!</strong>
                    <p class="block sm:inline">A ala que você está tentando acessar não existe.</p>
                    <p><a href="${window.location.pathname}" class="font-bold hover:underline">Voltar para a página inicial</a></p>
                </div>`;
        }

        // --- FUNÇÕES DE DADOS (FIRESTORE) ---

        async function loadAlaData(alaId) {
            const docRef = doc(db, `artifacts/${appId}/public_alas_data/${alaId}`);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    console.log("Dados carregados para:", alaId);
                    return docSnap.data();
                } else {
                    console.log("Nenhum documento encontrado para:", alaId);
                    // Retorna uma estrutura padrão se não houver dados
                    return { 
                        courseInfo: { name: '', startDate: '', endDate: ''},
                        participants: {} 
                    };
                }
            } catch (error) {
                console.error("Erro ao carregar dados: ", error);
                return { courseInfo: {}, participants: {} };
            }
        }

        async function saveParticipantName(alaId, participantIndex, name) {
            const docRef = doc(db, `artifacts/${appId}/public_alas_data/${alaId}`);
            try {
                const docSnap = await getDoc(docRef);
                const data = docSnap.exists() ? docSnap.data() : { participants: {}, courseInfo: {} };

                if (!data.participants) data.participants = {};
                if (!data.participants[participantIndex]) {
                    data.participants[participantIndex] = { name: '', attendance: Array(NUM_WEEKS).fill(false) };
                }
                
                data.participants[participantIndex].name = name;
                
                await setDoc(docRef, data);
                console.log(`Nome do participante ${participantIndex} salvo para ${alaId}`);
            } catch (error) {
                console.error("Erro ao salvar nome: ", error);
            }
        }

        async function saveAttendance(alaId, participantIndex, weekIndex, isChecked) {
            const docRef = doc(db, `artifacts/${appId}/public_alas_data/${alaId}`);
            try {
                const docSnap = await getDoc(docRef);
                const data = docSnap.exists() ? docSnap.data() : { participants: {}, courseInfo: {} };

                if (!data.participants) data.participants = {};
                if (!data.participants[participantIndex]) {
                    data.participants[participantIndex] = { name: '', attendance: Array(NUM_WEEKS).fill(false) };
                }
                
                if (!Array.isArray(data.participants[participantIndex].attendance) || data.participants[participantIndex].attendance.length !== NUM_WEEKS) {
                    data.participants[participantIndex].attendance = Array(NUM_WEEKS).fill(false);
                }
                
                data.participants[participantIndex].attendance[weekIndex] = isChecked;

                await setDoc(docRef, data);
                console.log(`Frequência da semana ${weekIndex} salva para o participante ${participantIndex} em ${alaId}`);
            } catch (error) {
                console.error("Erro ao salvar frequência: ", error);
            }
        }
        
        async function saveCourseInfo(alaId) {
             const name = document.getElementById('courseName').value;
             const startDate = document.getElementById('startDate').value;
             const endDate = document.getElementById('endDate').value;
             const courseInfo = { name, startDate, endDate };

             const docRef = doc(db, `artifacts/${appId}/public_alas_data/${alaId}`);
             try {
                const docSnap = await getDoc(docRef);
                const data = docSnap.exists() ? docSnap.data() : { participants: {}, courseInfo: {} };
                data.courseInfo = courseInfo;
                await setDoc(docRef, data);
                console.log(`Informações do curso salvas para ${alaId}`);
             } catch(error) {
                 console.error("Erro ao salvar informações do curso: ", error);
             }
        }

        // --- FUNÇÕES DE UI ---

        function updatePercentage(participantIndex) {
            let attendedCount = 0;
            for (let i = 0; i < NUM_WEEKS; i++) {
                const checkbox = document.getElementById(`week-${participantIndex}-${i}`);
                if (checkbox && checkbox.checked) {
                    attendedCount++;
                }
            }
            const percentage = (attendedCount / NUM_WEEKS * 100).toFixed(2);
            const percentageEl = document.getElementById(`percentage-${participantIndex}`);
            if(percentageEl) percentageEl.textContent = `${percentage}%`;
        }

    </script>
</body>
</html>
